<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JARVIS Neural Brain</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Minimal styled scrollbar */
    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #1a2535;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #2a3a4a;
    }

    body {
      background: #050508;
      color: #e0e0e0;
      font-family: 'SF Mono', 'Consolas', monospace;
      overflow: hidden;
      height: 100vh;
    }

    #canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .sidebar-left {
      position: fixed;
      top: 20px;
      left: 20px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      z-index: 100;
      max-height: calc(100vh - 40px);
      width: 400px;
    }

    .info-panel {
      background: rgba(10, 15, 25, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 1.25rem 1.5rem;
      backdrop-filter: blur(12px);
      width: 100%;
    }

    .info-panel h1 {
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .info-panel .stats {
      font-size: 0.75rem;
      color: #6a7a8a;
      margin-bottom: 0.5rem;
    }

    .info-panel .categories {
      display: none;
    }

    .categories-panel {
      width: 320px;
      height: 320px;
      background: rgba(10, 15, 25, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 1.5rem;
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .categories-list {
      overflow-y: auto;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding-right: 12px;
    }

    .categories-panel h3 {
      color: #6a7a8a;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 0.5rem;
    }

    .cat-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 0.8rem;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid transparent;
      border-radius: 10px;
      color: #8a9aaa;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 0.8rem;
    }

    .cat-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.1);
      color: #fff;
      transform: translateX(4px);
    }

    .cat-left {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .cat-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      position: relative;
    }

    .cat-dot::after {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      background: inherit;
      border-radius: 50%;
      opacity: 0.3;
      filter: blur(4px);
    }

    .cat-count {
      font-size: 0.65rem;
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 8px;
      border-radius: 20px;
      color: #6a7a8a;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .node-info {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(10, 15, 25, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 1.5rem;
      padding-right: 12px;
      width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 1000;
      backdrop-filter: blur(15px);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
      display: none;
    }

    .node-info.visible {
      display: block;
    }

    .node-info h3 {
      color: #00d4ff;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    .node-info .content {
      font-size: 0.85rem;
      line-height: 1.6;
      color: #c0c0c0;
      margin-bottom: 1rem;
      white-space: normal;
      word-wrap: break-word;
    }

    .node-info .connections {
      border-top: 1px solid #2d3a4d;
      padding-top: 0.75rem;
    }

    .node-info .connections h4 {
      color: #6a7a8a;
      font-size: 0.7rem;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }

    .node-info .conn-item {
      font-size: 0.75rem;
      color: #8a9aaa;
      margin: 0.3rem 0;
    }

    .controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 0.5rem;
      z-index: 100;
    }

    .legend {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(10, 15, 25, 0.9);
      border: 1px solid #1a2535;
      border-radius: 12px;
      padding: 1rem;
      z-index: 100;
      font-size: 0.7rem;
    }

    .legend h3 {
      margin-bottom: 0.5rem;
      color: #6a7a8a;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.3rem 0;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .btn {
      background: #0a1520;
      border: 1px solid #2a3545;
      color: #00d4ff;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
      font-family: 'SF Mono', 'Consolas', monospace;
    }

    .btn:hover {
      background: #152030;
      color: #fff;
      border-color: #00d4ff;
    }

    .connections-panel {
      width: 320px;
      height: 230px;
      background: rgba(10, 15, 25, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 1.25rem;
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .activity-panel {
      width: 320px;
      height: 230px;
      background: rgba(10, 15, 25, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 1.25rem;
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .connections-list {
      overflow-y: auto;
      flex-grow: 1;
      font-size: 0.7rem;
      color: #8a9aaa;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      padding-right: 12px;
    }

    .conn-list-item {
      padding: 0.4rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .conn-list-item:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
    }

    .conn-list-item .time {
      color: #6a7a8a;
      font-size: 0.6rem;
      margin-right: 0.5rem;
    }

    .connections-panel h3,
    .activity-panel h3 {
      font-size: 0.75rem;
      color: #6a7a8a;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .activity-panel h3::before {
      content: '';
      width: 8px;
      height: 8px;
      background: #00d4ff;
      border-radius: 50%;
      box-shadow: 0 0 10px #00d4ff;
      animation: pulse 2s infinite;
    }

    .activity-stream {
      overflow-y: auto;
      flex-grow: 1;
      font-size: 0.75rem;
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      padding-right: 12px;
    }

    .activity-item {
      padding: 0.5rem;
      border-left: 2px solid #2d3a4d;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 0 4px 4px 0;
      animation: slideIn 0.3s ease-out;
    }

    .activity-item .time {
      color: #6a7a8a;
      font-size: 0.65rem;
      margin-bottom: 0.2rem;
    }

    .activity-item .msg {
      color: #c0c0c0;
    }

    .activity-item.new-node {
      border-left-color: #00d4ff;
    }

    .activity-item.new-link {
      border-left-color: #a855f7;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 0.8;
      }

      50% {
        transform: scale(1.2);
        opacity: 1;
      }

      100% {
        transform: scale(1);
        opacity: 0.8;
      }
    }

    .node-label {
      color: #fff;
      font-family: 'SF Mono', 'Consolas', monospace;
      font-size: 10px;
      padding: 2px 6px;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      pointer-events: none;
      white-space: nowrap;
      backdrop-filter: blur(4px);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: opacity 0.3s;
      z-index: 1000;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>
</head>

<body>
  <canvas id="canvas"></canvas>

  <div class="sidebar-left">
    <div class="info-panel">
      <h1>ü¶û JARVIS Neural Brain</h1>
      <div class="stats">
        <span id="nodeCount">0</span> Neuronen ¬∑
        <span id="linkCount">0</span> Synapsen ¬∑
        <span id="zoomLevel">100%</span>
      </div>
    </div>

    <div class="categories-panel">
      <h3>Kategorien</h3>
      <div class="categories-list">
        <div class="cat-item" onmouseover="highlightCategory('carsten')" onmouseout="highlightCategory(null)">
          <div class="cat-left">
            <span class="cat-dot" style="background:#10b981"></span>
            <span>Carsten</span>
          </div>
          <span class="cat-count" id="count-carsten">0</span>
        </div>
        <div class="cat-item" onmouseover="highlightCategory('jarvis')" onmouseout="highlightCategory(null)">
          <div class="cat-left">
            <span class="cat-dot" style="background:#a855f7"></span>
            <span>JARVIS</span>
          </div>
          <span class="cat-count" id="count-jarvis">0</span>
        </div>
        <div class="cat-item" onmouseover="highlightCategory('regeln')" onmouseout="highlightCategory(null)">
          <div class="cat-left">
            <span class="cat-dot" style="background:#f59e0b"></span>
            <span>Regeln</span>
          </div>
          <span class="cat-count" id="count-regeln">0</span>
        </div>
        <div class="cat-item" onmouseover="highlightCategory('skills')" onmouseout="highlightCategory(null)">
          <div class="cat-left">
            <span class="cat-dot" style="background:#00d4ff"></span>
            <span>Skills</span>
          </div>
          <span class="cat-count" id="count-skills">0</span>
        </div>
        <div class="cat-item" onmouseover="highlightCategory('projekt')" onmouseout="highlightCategory(null)">
          <div class="cat-left">
            <span class="cat-dot" style="background:#ef4444"></span>
            <span>Projekt</span>
          </div>
          <span class="cat-count" id="count-projekt">0</span>
        </div>
        <div class="cat-item" onmouseover="highlightCategory('workflow')" onmouseout="highlightCategory(null)">
          <div class="cat-left">
            <span class="cat-dot" style="background:#6a7a8a"></span>
            <span>Workflow</span>
          </div>
          <span class="cat-count" id="count-workflow">0</span>
        </div>
        <div class="cat-item" onmouseover="highlightCategory('user')" onmouseout="highlightCategory(null)">
          <div class="cat-left">
            <span class="cat-dot" style="background:#4a5568"></span>
            <span>User</span>
          </div>
          <span class="cat-count" id="count-user">0</span>
        </div>
      </div>
    </div>

    <div class="node-info" id="nodeInfo">
      <h3 id="infoTitle">Node</h3>
      <div class="content" id="infoContent">...</div>
      <div class="connections">
        <h4>Verkn√ºpfungen</h4>
        <div id="infoConnections"></div>
      </div>
    </div>

    <div class="connections-panel">
      <h3>Synapsen-Liste</h3>
      <div class="connections-list" id="connectionsList"></div>
    </div>

    <div class="activity-panel">
      <h3>Activity Stream</h3>
      <div class="activity-stream" id="activityStream">
        <div class="activity-item">
          <div class="msg">Initialisiere Neural Brain...</div>
        </div>
      </div>
    </div>
  </div>

  <div class="controls">
    <button class="btn" onclick="resetView()">Reset</button>
    <button class="btn" id="btnView" onclick="toggleView()">View: 3D</button>
    <button class="btn" id="btnPulse" onclick="togglePulse()">Pulse: ON</button>
    <button class="btn" id="btnMove" onclick="toggleMove()">Bewegung: ON</button>
  </div>

  <div class="legend" style="display:none;">
    <h3>Kategorien</h3>
    <div class="legend-item"><span class="legend-dot" style="background:#10b981"></span> Carsten</div>
    <div class="legend-item"><span class="legend-dot" style="background:#a855f7"></span> JARVIS</div>
    <div class="legend-item"><span class="legend-dot" style="background:#f59e0b"></span> Regeln</div>
    <div class="legend-item"><span class="legend-dot" style="background:#00d4ff"></span> Skills</div>
    <div class="legend-item"><span class="legend-dot" style="background:#ef4444"></span> Projekt</div>
    <div class="legend-item"><span class="legend-dot" style="background:#6a7a8a"></span> Workflow</div>
  </div>

  <script>
    // Stubs for global functions to prevent ReferenceError before module loads
    window.highlightCategory = window.highlightCategory || function () { };
    window.highlightLink = window.highlightLink || function () { };
    window.toggleView = window.toggleView || function () { };
    window.togglePulse = window.togglePulse || function () { };
    window.toggleMove = window.toggleMove || function () { };
    window.resetView = window.resetView || function () { };
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

    // --- Three.js Setup ---
    let scene, camera, renderer, labelRenderer, controls, raycaster;
    const mouse = new THREE.Vector2();
    let width = window.innerWidth;
    let height = window.innerHeight;

    const streamEl = document.getElementById('activityStream');
    function addActivity(msg, type = '') {
      const item = document.createElement('div');
      item.className = 'activity-item' + (type ? ' ' + type : '');
      const timeStr = new Date().toLocaleTimeString();
      item.innerHTML = `<div class="time">${timeStr}</div><div class="msg">${msg}</div>`;
      streamEl.insertBefore(item, streamEl.firstChild);
      if (streamEl.children.length > 100) streamEl.lastChild.remove();
    }

    let nodes = [];
    let links = [];
    let nodeMeshes = [];
    let nodeLabels = [];
    let linkLines = [];
    let pulseEnabled = true;
    let moveEnabled = true;
    let viewMode = '3D'; // '2D' or '3D'
    let hoveredNode = null;
    let highlightedCategory = null;
    let highlightedLinkIndex = -1;

    const colors = {
      carsten: 0x10b981,
      jarvis: 0xa855f7,
      regeln: 0xf59e0b,
      skills: 0x00d4ff,
      projekt: 0xef4444,
      workflow: 0x6a7a8a,
      user: 0x4a5568
    };

    const labels = {
      carsten: 'üë§ Carsten',
      jarvis: 'ü¶û JARVIS',
      regeln: 'üìã Regeln',
      skills: 'üíª Skills',
      projekt: 'üåê Projekt',
      workflow: '‚öôÔ∏è Workflow',
      user: 'üí¨ User'
    };

    function initThree() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x050508);
      // scene.fog = new THREE.FogExp2(0x050508, 0.001);

      camera = new THREE.PerspectiveCamera(60, width / height, 1, 10000);
      camera.position.z = 1000;

      renderer = new THREE.WebGLRenderer({
        canvas: document.getElementById('canvas'),
        antialias: true,
        alpha: true
      });
      renderer.setSize(width, height);
      renderer.setPixelRatio(window.devicePixelRatio);

      labelRenderer = new CSS2DRenderer();
      labelRenderer.setSize(width, height);
      labelRenderer.domElement.style.position = 'absolute';
      labelRenderer.domElement.style.top = '0px';
      labelRenderer.domElement.style.pointerEvents = 'none';
      document.body.appendChild(labelRenderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.rotateSpeed = 0.5;

      raycaster = new THREE.Raycaster();

      // Lights
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);

      const pointLight = new THREE.PointLight(0xffffff, 1);
      pointLight.position.set(500, 500, 500);
      scene.add(pointLight);
    }

    function detectCategory(text) {
      const t = text.toLowerCase();
      if (t.includes('carsten') || t.includes('geburtstag') || t.includes('wohnort') || t.includes('arbeit') || t.includes('kastner')) return 'carsten';
      if (t.includes('jarvis') || t.includes('identit√§t') || t.includes('aufgaben') || t.includes('schicksal')) return 'jarvis';
      if (t.includes('regel') || t.includes('fakt') || t.includes('ehrlich') || t.includes('l√ºgen')) return 'regeln';
      if (t.includes('skill') || t.includes('react') || t.includes('golang') || t.includes('programm') || t.includes('go,')) return 'skills';
      if (t.includes('projekt') || t.includes('weiberwirtschaft') || t.includes('vercel')) return 'projekt';
      if (t.includes('workflow') || t.includes('plan') || t.includes('subagent')) return 'workflow';
      return 'user';
    }

    async function loadData() {
      try {
        const res = await fetch('http://localhost:9124/seeds/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: 'der', limit: 100, threshold: 0 })
        });
        const data = await res.json();
        return data.results || [];
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    // Seeded random for deterministic results
    let seed = 12345;
    let lastSeedIds = [];

    function seededRandom() {
      seed = (seed * 9301 + 49297) % 233280;
      return seed / 233280;
    }

    async function updateData() {
      const seeds = await loadData();
      const currentSeedIds = seeds.map(s => s.seedId).sort();

      if (lastSeedIds.length > 0) {
        const newIds = currentSeedIds.filter(id => !lastSeedIds.includes(id));
        newIds.forEach(id => {
          const s = seeds.find(seed => seed.seedId === id);
          if (s) {
            const cat = detectCategory(s.content);
            addActivity(`Neues Neuron #${id} gebildet (${cat})`, 'new-node');
          }
        });
      }

      const hasNewSeeds = currentSeedIds.length > lastSeedIds.length ||
        !currentSeedIds.every((id, i) => id === lastSeedIds[i]);

      if (hasNewSeeds || nodes.length === 0) {
        lastSeedIds = currentSeedIds;
        seed = 12345;

        // Clear existing Three.js objects
        nodeMeshes.forEach(m => scene.remove(m));
        nodeLabels.forEach(l => scene.remove(l));
        linkLines.forEach(l => scene.remove(l));
        nodeMeshes = [];
        nodeLabels = [];
        linkLines = [];
        nodes = [];
        links = [];

        // Create 3D nodes
        nodes = seeds.map((s, i) => {
          const cat = detectCategory(s.content);
          const phi = Math.acos(-1 + (2 * i) / seeds.length);
          const theta = Math.sqrt(seeds.length * Math.PI) * phi;
          const radius = 600 + seededRandom() * 400;

          return {
            id: s.seedId,
            content: s.content,
            category: cat,
            x: radius * Math.cos(theta) * Math.sin(phi),
            y: radius * Math.sin(theta) * Math.sin(phi),
            z: radius * Math.cos(phi),
            vx: (seededRandom() - 0.5) * 0.5,
            vy: (seededRandom() - 0.5) * 0.5,
            vz: (seededRandom() - 0.5) * 0.5,
            baseRadius: 10 + seededRandom() * 15,
            pulse: seededRandom() * Math.PI * 2
          };
        });

        // JARVIS core
        nodes.push({
          id: 'jarvis-core',
          content: 'JARVIS - Just a Very Intelligent System',
          category: 'jarvis',
          x: 0, y: 0, z: 0,
          vx: 0, vy: 0, vz: 0,
          baseRadius: 50,
          pulse: 0,
          isCore: true
        });

        // Create meshes
        const sphereGeom = new THREE.SphereGeometry(1, 16, 16);
        nodes.forEach((n, i) => {
          const mat = new THREE.MeshPhongMaterial({
            color: colors[n.category],
            emissive: colors[n.category],
            emissiveIntensity: 0.5,
            shininess: 100
          });
          const mesh = new THREE.Mesh(sphereGeom, mat);
          mesh.position.set(n.x, n.y, n.z);
          mesh.scale.setScalar(n.baseRadius);
          mesh.userData = { index: i };
          scene.add(mesh);
          nodeMeshes.push(mesh);

          // Create Label
          const labelDiv = document.createElement('div');
          labelDiv.className = 'node-label';
          if (n.isCore) {
            labelDiv.textContent = 'ü¶û JARVIS Core';
            labelDiv.style.fontSize = '12px';
            labelDiv.style.fontWeight = 'bold';
            labelDiv.style.borderColor = 'rgba(168, 85, 247, 0.4)';
          } else {
            labelDiv.textContent = labels[n.category] || 'Node';
          }
          const label = new CSS2DObject(labelDiv);
          // Standard center alignment for CSS2DObject
          scene.add(label);
          nodeLabels.push(label);
        });

        // Create links
        for (let i = 0; i < nodes.length; i++) {
          for (let j = i + 1; j < nodes.length; j++) {
            const a = nodes[i], b = nodes[j];
            const dist = Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2 + (a.z - b.z) ** 2);
            if (dist < 400 || (a.category === b.category && dist < 600)) {
              links.push({ source: i, target: j, strength: 1 - dist / 600 });
            }
          }
        }

        // Strong links to core
        nodes.forEach((n, i) => {
          if (!n.isCore) {
            links.push({ source: nodes.length - 1, target: i, strength: 0.4 });
          }
        });

        // Create link lines
        links.forEach(l => {
          const a = nodes[l.source];
          const b = nodes[l.target];
          const geometry = new THREE.BufferGeometry().setFromPoints([
            new THREE.Vector3(a.x, a.y, a.z),
            new THREE.Vector3(b.x, b.y, b.z)
          ]);

          const colors_arr = [];
          const c1 = new THREE.Color(colors[a.category]);
          const c2 = new THREE.Color(colors[b.category]);
          colors_arr.push(c1.r, c1.g, c1.b);
          colors_arr.push(c2.r, c2.g, c2.b);
          geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors_arr, 3));

          const mat = new THREE.LineBasicMaterial({
            vertexColors: true,
            transparent: true,
            opacity: 0.2,
            linewidth: 1
          });

          const line = new THREE.Line(geometry, mat);
          scene.add(line);
          linkLines.push(line);
        });
      }

      document.getElementById('nodeCount').textContent = nodes.length;
      document.getElementById('linkCount').textContent = links.length;

      // Update category counts
      const counts = { carsten: 0, jarvis: 0, regeln: 0, skills: 0, projekt: 0, workflow: 0, user: 0 };
      nodes.forEach(n => { if (counts[n.category] !== undefined) counts[n.category]++; });
      Object.keys(counts).forEach(cat => {
        const el = document.getElementById(`count-${cat}`);
        if (el) el.textContent = counts[cat];
      });

      // Update connections list
      const listEl = document.getElementById('connectionsList');
      if (links.length === 0) {
        listEl.innerHTML = '<div class="conn-list-item">Warten auf Synapsen...</div>';
      } else {
        const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const last100 = links.map((l, i) => ({ ...l, originalIdx: i })).slice(-100).reverse();

        listEl.innerHTML = last100.map(l => {
          const a = nodes[l.source], b = nodes[l.target];
          if (!a || !b) return '';
          const aLabel = a.isCore ? 'JARVIS' : `#${a.id}`;
          const bLabel = b.isCore ? 'JARVIS' : `#${b.id}`;
          const cat = a.isCore ? b.category : a.category;
          return `<div class="conn-list-item" onmouseover="highlightLink(${l.originalIdx})" onmouseout="highlightLink(-1)">
                    <span>${aLabel} ‚Üî ${bLabel} (${labels[cat] || cat})</span>
                    <span class="time">${timeStr}</span>
                  </div>`;
        }).join('');
      }
    }

    function updatePhysics() {
      if (!moveEnabled) return;

      // Update positions
      nodes.forEach((n, i) => {
        if (!n.isCore) {
          n.x += n.vx;
          n.y += n.vy;
          if (viewMode === '3D') {
            n.z += n.vz;
          } else {
            n.z *= 0.9; // Smoothly flatten to 2D plane
            n.vz = 0;
          }

          // Box constraints
          const limit = 1500;
          if (Math.abs(n.x) > limit) n.vx *= -1;
          if (Math.abs(n.y) > limit) n.vy *= -1;
          if (viewMode === '3D' && Math.abs(n.z) > limit) n.vz *= -1;
        }
        n.pulse += 0.02;

        // Apply to meshes
        const mesh = nodeMeshes[i];
        if (mesh) {
          mesh.position.set(n.x, n.y, n.z);
          const pulse = pulseEnabled ? Math.sin(n.pulse) * 2 : 0;
          const s = (n.baseRadius + pulse) / n.baseRadius;

          let targetScale = n.baseRadius + pulse;
          if (highlightedCategory && n.category === highlightedCategory) {
            targetScale *= 1.5;
            mesh.material.emissiveIntensity = 1.0;
          } else {
            mesh.material.emissiveIntensity = 0.5;
          }
          mesh.scale.setScalar(targetScale);

          // Fix label position to be strictly under the neuron
          const label = nodeLabels[i];
          if (label) {
            label.position.set(n.x, n.y - targetScale - 20, n.z);
          }
        }
      });

      // Link forces
      links.forEach((l, i) => {
        const a = nodes[l.source], b = nodes[l.target];
        const dx = b.x - a.x, dy = b.y - a.y, dz = b.z - a.z;
        const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);
        const force = (dist - 500) * 0.0001;
        if (!a.isCore) { a.x += dx * force; a.y += dy * force; a.z += dz * force; }
        if (!b.isCore) { b.x -= dx * force; b.y -= dy * force; b.z -= dz * force; }

        // Update link lines
        const line = linkLines[i];
        if (line) {
          const positions = line.geometry.attributes.position.array;
          positions[0] = a.x; positions[1] = a.y; positions[2] = a.z;
          positions[3] = b.x; positions[4] = b.y; positions[5] = b.z;
          line.geometry.attributes.position.needsUpdate = true;

          const isHovered = hoveredNode && (l.source === nodes.indexOf(hoveredNode) || l.target === nodes.indexOf(hoveredNode));
          const isHighlighted = (i === highlightedLinkIndex);

          if (isHighlighted) {
            line.material.opacity = 0.9;
            line.material.linewidth = 3;
            line.material.color.setHex(0xffffff);
          } else if (isHovered) {
            line.material.opacity = 0.7;
            line.material.linewidth = 2;
            line.material.color.setHex(0xffffff);
          } else {
            line.material.opacity = 0.15;
            line.material.linewidth = 1;
            line.material.color.setHex(0xffffff);
          }
        }
      });

      // Collision Detection (Avoid overlap)
      for (let i = 0; i < nodes.length; i++) {
        for (let j = i + 1; j < nodes.length; j++) {
          const a = nodes[i], b = nodes[j];
          const dx = b.x - a.x, dy = b.y - a.y;
          const dz = (viewMode === '3D') ? (b.z - a.z) : 0;
          const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);

          // Collision distance: sum of radii + space for label
          const minDist = (a.baseRadius + b.baseRadius) + 200;

          if (dist < minDist && dist > 0) {
            const overlap = minDist - dist;
            const nx = dx / dist, ny = dy / dist, nz = dz / dist;
            const push = (viewMode === '2D' ? overlap * 0.2 : overlap * 0.1);

            if (!a.isCore) {
              a.x -= nx * push;
              a.y -= ny * push;
              if (viewMode === '3D') a.z -= nz * push;
            }
            if (!b.isCore) {
              b.x += nx * push;
              b.y += ny * push;
              if (viewMode === '3D') b.z += nz * push;
            }
          }
        }
      }
    }

    function animate() {
      requestAnimationFrame(animate);

      updatePhysics();
      controls.update();

      // Raycasting
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(nodeMeshes);

      const info = document.getElementById('nodeInfo');
      if (intersects.length > 0) {
        const index = intersects[0].object.userData.index;
        hoveredNode = nodes[index];

        info.classList.add('visible');
        document.getElementById('infoTitle').textContent = labels[hoveredNode.category] || 'Node #' + hoveredNode.id;
        document.getElementById('infoContent').textContent = hoveredNode.content;

        const conns = [];
        links.forEach(l => {
          if (l.source === index || l.target === index) {
            const otherIdx = l.source === index ? l.target : l.source;
            const other = nodes[otherIdx];
            conns.push({ name: labels[other.category] || 'Node', id: other.id });
          }
        });

        const connHtml = conns.length > 0
          ? conns.slice(0, 5).map(c => `<div class="conn-item">‚óè ${c.name} #${c.id}</div>`).join('')
          : '<div class="conn-item">Keine Verkn√ºpfungen</div>';
        document.getElementById('infoConnections').innerHTML = connHtml;
      } else {
        hoveredNode = null;
        info.classList.remove('visible');
      }

      document.getElementById('zoomLevel').textContent = Math.round(100000 / camera.position.length()) + '%';
      renderer.render(scene, camera);
      labelRenderer.render(scene, camera);
    }

    window.addEventListener('mousemove', (e) => {
      mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
    });

    window.addEventListener('resize', () => {
      width = window.innerWidth;
      height = window.innerHeight;
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
      renderer.setSize(width, height);
      labelRenderer.setSize(width, height);
    });

    function resetView() {
      controls.reset();
      highlightedCategory = null;
    }
    window.resetView = resetView;

    function togglePulse() {
      pulseEnabled = !pulseEnabled;
      document.getElementById('btnPulse').textContent = 'Pulse: ' + (pulseEnabled ? 'ON' : 'OFF');
    }
    window.togglePulse = togglePulse;

    function toggleMove() {
      moveEnabled = !moveEnabled;
      document.getElementById('btnMove').textContent = 'Bewegung: ' + (moveEnabled ? 'ON' : 'OFF');
    }
    window.toggleMove = toggleMove;

    function highlightCategory(cat) {
      highlightedCategory = cat;
    }
    window.highlightCategory = highlightCategory;

    function highlightLink(idx) {
      highlightedLinkIndex = idx;
    }
    window.highlightLink = highlightLink;

    function toggleView() {
      viewMode = (viewMode === '3D' ? '2D' : '3D');
      document.getElementById('btnView').textContent = 'View: ' + viewMode;

      if (viewMode === '2D') {
        // Lock to 2D
        controls.enableRotate = false;
        // Animate camera to front view
        const targetPos = new THREE.Vector3(0, 0, 1500);
        const duration = 1000;
        const startPos = camera.position.clone();
        const startTime = Date.now();

        function anim() {
          const now = Date.now();
          const p = Math.min(1, (now - startTime) / duration);
          const ease = p * (2 - p);
          camera.position.lerpVectors(startPos, targetPos, ease);
          camera.lookAt(0, 0, 0);
          if (p < 1) requestAnimationFrame(anim);
        }
        anim();
      } else {
        // Re-enable 3D
        controls.enableRotate = true;
        // Give nodes back their 3D depth and movement
        nodes.forEach(n => {
          if (!n.isCore) {
            n.vz = (seededRandom() - 0.5) * 0.5;
            // Slightly spread out in Z immediately if they were at 0
            if (Math.abs(n.z) < 1) {
              n.z = (seededRandom() - 0.5) * 400;
            }
          }
        });
      }
    }
    window.toggleView = toggleView;

    initThree();
    updateData().then(animate);
    setInterval(updateData, 15000);
  </script>
</body>

</html>